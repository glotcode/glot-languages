use crate::language::EditorConfig;
use crate::language::LanguageConfig;
use crate::language::RunConfig;
use crate::language::RunInstructions;
use crate::utils;
use maud::html;
use maud::Markup;
use std::path::PathBuf;

const EXAMPLE_CODE: &str = r#"
       IDENTIFICATION DIVISION.
       PROGRAM-ID. hello.

       PROCEDURE DIVISION.
           DISPLAY 'Hello World!'
           GOBACK
           .
"#;

#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]
pub struct Cobol;

impl LanguageConfig for Cobol {
    fn id(&self) -> String {
        "cobol".to_string()
    }

    fn name(&self) -> String {
        "Cobol".to_string()
    }

    fn file_extension(&self) -> String {
        "cob".to_string()
    }

    fn editor_config(&self) -> EditorConfig {
        EditorConfig {
            default_filename: format!("main.{}", self.file_extension()),
            mode: "ace/mode/cobol".to_string(),
            use_soft_tabs: true,
            soft_tab_size: 4,
            example_code: EXAMPLE_CODE.trim_matches('\n').to_string(),
        }
    }

    fn run_config(&self) -> RunConfig {
        RunConfig {
            container_image: "glot/cobol:latest".to_string(),
            version_command: "cobc --version | head -n 1".to_string(),
        }
    }

    fn logo(&self) -> Markup {
        html! {
            svg xmlns="http://www.w3.org/2000/svg" space="preserve" viewBox="0 0 512 512" {
                path fill-rule="evenodd" d="M499.217 160.212s7.598-7.103 9.61-20.435c2.479-16.476.299-36.537.299-36.537s-5.106 15.204-13.132 24.839c-6.176 7.415-16.593 12.317-16.593 12.317s-31.908 3.082-48.792-3.955c-11.985-4.99-10.663-20.818-10.663-20.818s7.161-9.074 16.609-18.871c7.02-7.27 15.67-14.202 21.637-22.02 8.542-11.199 9.648-21.866 9.648-21.866s-27.813 13.657-49.961 29.139c-14.654 10.243-26.835 24.536-26.835 24.536l-4.13-6.604s12.347-13.128 15.728-28.436c3.627-16.443-1.688-35.148-1.688-35.148s-4.113 16.56-12.626 28.998C380.797 76.359 368.75 83.42 368.75 83.42s-6.088.978-9.527-2.911c-5.539-6.254-9.465-18.555-9.465-18.555s-6.383 4.171-12.13 1.946c-6.937-2.687-13.466-11.86-13.466-11.86s-8.067 5.988-18.189 8.413c-8.778 2.1-19.795.669-19.795.669s-3.692 5.473-12.517 8.142c-8.929 2.703-22.997 2.595-22.997 2.595s4.047 10.164-1.622 17.649c-5.893 7.785-21.496 12.908-21.496 12.908l14.043 14.035s-7.173 3.156-18.472 13.021c-8.6 7.51-17.187 18.988-25.188 26.764-7.689 7.477-14.971 11.411-14.971 11.411s-42.379 3.9-68.849 42.933c-20.946 30.902-9.598 80.102-9.598 80.102s-29.721 30.631-62.707 2.753c-37.585-31.771-14.913-80.373-14.913-80.373s-49.395 31.301-13.041 97.331c36.708 66.678 101.397 34.79 101.397 34.79l-3.306 15.687-6.604 8.259 3.302 7.431s1.955 9.739 1.713 17.388c-.154 4.957-2.537 9.032-2.537 9.032s-3.905 8.662-2.699 13.49c1.269 5.073 7.648 6.329 7.648 6.329s2.719 6.766 7.028 8.021c5.464 1.593 12.796-2.241 12.796-2.241s8.358 4.267 14.609 2.856c6.541-1.479 10.987-8.637 10.987-8.637s7.36.956 11.199-1.389c3.584-2.188 3.664-7.693 3.664-7.693l-17.341-15.687-.828-23.948s15.44-17.171 22.381-34.279c5.189-12.809 2.391-26.826 2.391-26.826s6.658-4.962 14.542-1.889c6.616 2.583 12.679 12.28 19.125 16.518 7.581 4.982 15.054 4.362 15.054 4.362s-1.206 9.682-.757 17.479c.37 6.541 2.408 11.424 2.408 11.424s5.656 4.017 8.658 10.209c3.497 7.215 4.807 17.195 11.182 24.132 4.508 4.907 10.151 4.583 14.697 7.19 7.231 4.146 12.529 9.664 12.529 9.664s6.209 9.028 6.209 19.683c0 7.373-6.521 14.389-8.01 20.863-1.605 6.974 1.801 13.129 1.801 13.129s6.916-.125 11.161 1.763c6.434 2.856 11.137 8.143 11.137 8.143s7.918-5.756 16.543-6.4c7.852-.595 16.484 3.926 16.484 3.926s5.56-.357 8.563-3.435c2.604-2.662 2.44-7.922 5.423-9.873 5.468-3.58 9.959-2.383 9.959-2.383s5.964-6.578 2.861-12.642c-2.212-4.316-8.6-6.088-12.555-9.889-5.099-4.907-7.644-11.324-7.644-11.324l9.083-10.732s7.36 3.68 13.474 4.52c5.854.812 10.471-1.218 10.471-1.218l.823-5.78s-12.234-21.259-14.072-51.242c-1.343-21.948 7.735-46.696 8.991-67.726 1.435-23.986-4.824-42.878-4.824-42.878s3.127-6.799 13.062-8.379c14.842-2.362 63.751 12.488 85.242 10.438 27.479-2.628 26.382-21.874 26.382-21.874s-8.155 4.591-17.142-.366c-11.033-6.076-23.317-21.932-23.317-21.932s11.369-6.524 29.912-.416c13.694 4.512 20.456 22.714 20.456 22.714s13.553-11.324 13.923-26.39c.454-18.1-12.267-42.153-12.267-42.153M303.188 357.144l-3.602-30.149 11.702-3.601 2.25 42.754z" clip-rule="evenodd" {
                }
            }
        }
    }

    fn run_instructions(&self, main_file: PathBuf, other_files: Vec<PathBuf>) -> RunInstructions {
        let other_source_files = utils::filter_by_extension(other_files, "cob");

        RunInstructions {
            build_commands: vec![format!(
                "cobc -x -o a.out {} {}",
                main_file.display(),
                utils::join_files(other_source_files)
            )],
            run_command: "./a.out".to_string(),
        }
    }
}
